<div class="space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Meus Pacientes</h1>
      <p class="mt-1 text-sm text-gray-500">
        Gerencie e acompanhe seus pacientes vinculados
      </p>
    </div>
  </div>

  <div class="rounded-lg bg-white p-6 shadow-sm">
    <div class="mb-6">
      <div class="flex items-end space-x-4">
        <div class="flex-grow">
          <label for="search" class="block text-sm font-medium text-gray-700">
            Nome ou CPF do Paciente
          </label>
          <div class="relative mt-1">
            <div
              class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"
            >
              <svg
                class="h-5 w-5 text-gray-400"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <input
              type="text"
              id="search"
              [value]="searchQuery()"
              (input)="onSearchChange($event)"
              placeholder="Digite o nome ou CPF..."
              class="block w-full rounded-md border-gray-300 py-2 pl-10 pr-3 shadow-sm focus:border-primary focus:ring-primary sm:text-sm"
            />
          </div>
        </div>

        <div class="flex-shrink-0">
          <label for="status" class="block text-sm font-medium text-gray-700">
            Status
          </label>
          <select
            id="status"
            [value]="selectedStatus()"
            (change)="onStatusChange($event)"
            class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base shadow-sm focus:border-primary focus:outline-none focus:ring-primary sm:text-sm"
          >
            <option value="">Todos</option>
            <option value="stable">Estável</option>
            <option value="attention">Atenção</option>
            <option value="critical">Crítico</option>
          </select>
        </div>

        <div class="flex-shrink-0">
          <label for="testType" class="block text-sm font-medium text-gray-700">
            Último Teste
          </label>
          <select
            id="testType"
            [value]="selectedTestType()"
            (change)="onTestTypeChange($event)"
            class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base shadow-sm focus:border-primary focus:outline-none focus:ring-primary sm:text-sm"
          >
            <option value="">Todos</option>
            <option value="spiral">Espiral</option>
            <option value="voice">Voz</option>
          </select>
        </div>

        <div class="flex-shrink-0">
          <label for="sortBy" class="block text-sm font-medium text-gray-700">
            Ordenar por
          </label>
          <select
            id="sortBy"
            [value]="sortBy()"
            (change)="onSortChange($event)"
            class="mt-1 block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base shadow-sm focus:border-primary focus:outline-none focus:ring-primary sm:text-sm"
          >
            <option value="name">Nome</option>
            <option value="age">Idade</option>
            <option value="lastTestDate">Último Teste</option>
          </select>
        </div>

        <div class="flex-shrink-0">
          <label class="block text-sm font-medium text-gray-700">
            Ordem
          </label>
          <button
            type="button"
            (click)="toggleSortOrder()"
            class="mt-1 inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
            title="{{ sortOrder() === 'asc' ? 'Crescente' : 'Decrescente' }}"
          >
            @if (sortOrder() === 'asc') {
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0l-3.75-3.75M17.25 21L21 17.25"
              />
            </svg>
            } @else {
            <svg
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12"
              />
            </svg>
            }
          </button>
        </div>

        <div class="flex-shrink-0">
          <button
            type="button"
            (click)="onSearch()"
            class="mt-6 inline-flex items-center rounded-md border border-transparent bg-violet-700 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-violet-800 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          >
            Pesquisar
          </button>
        </div>
      </div>
    </div>

    @if (isLoading()) {
    <div class="flex h-64 items-center justify-center">
      <div class="text-center">
        <svg
          class="mx-auto h-12 w-12 animate-spin text-violet-600"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          ></path>
        </svg>
        <p class="mt-2 text-sm text-gray-500">Carregando pacientes...</p>
      </div>
    </div>
    } @else if (patients().length === 0) {
    <div class="py-12 text-center">
      <svg
        class="mx-auto h-12 w-12 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
        />
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">
        Nenhum paciente encontrado
      </h3>
      <p class="mt-1 text-sm text-gray-500">
        Tente ajustar os filtros ou realizar uma nova busca.
      </p>
    </div>
    } @else {
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
            >
              Paciente
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
            >
              Idade
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
            >
              Último Teste
            </th>
            <th
              scope="col"
              class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500"
            >
              Status
            </th>
            <th scope="col" class="relative px-6 py-3">
              <span class="sr-only">Ações</span>
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          @for (patient of patients(); track patient.id) {
          <tr class="hover:bg-gray-50">
            <td class="whitespace-nowrap px-6 py-4">
              <div class="flex items-center">
                <div
                  class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-violet-100 text-violet-700"
                >
                  <span class="font-semibold">{{
                    patient.name.charAt(0).toUpperCase()
                  }}</span>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">
                    {{ patient.name }}
                  </div>
                  <div class="text-sm text-gray-500">{{ patient.cpf | cpf }}</div>
                </div>
              </div>
            </td>
            <td class="whitespace-nowrap px-6 py-4">
              <div class="text-sm text-gray-900">{{ patient.age }} anos</div>
            </td>
            <td class="whitespace-nowrap px-6 py-4">
              <div class="text-sm text-gray-900">
                {{ formatDate(patient.lastTestDate) }}
              </div>
              <div class="text-sm text-gray-500">
                {{ getTestTypeLabel(patient.lastTestType) }}
              </div>
            </td>
            <td class="whitespace-nowrap px-6 py-4">
              <span
                [class]="getStatusClass(patient.status)"
                class="inline-flex rounded-full px-2 text-xs font-semibold leading-5"
              >
                {{ getStatusLabel(patient.status) }}
              </span>
            </td>
            <td
              class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium"
            >
              <div class="flex items-center justify-end space-x-3">
                <a
                  [routerLink]="['/dashboard/doctor/patient', patient.id]"
                  class="text-violet-600 hover:text-violet-900"
                  >Ver Detalhes</a
                >
                <button
                  (click)="unlinkPatient(patient)"
                  class="text-red-600 hover:text-red-900"
                  title="Desvincular paciente"
                >
                  Desvincular
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <div
      class="mt-6 flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6"
    >
      <div class="flex flex-1 justify-between sm:hidden">
        <button
          (click)="previousPage()"
          [disabled]="currentPage() === 1"
          [class.opacity-50]="currentPage() === 1"
          [class.cursor-not-allowed]="currentPage() === 1"
          class="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          Anterior
        </button>
        <button
          (click)="nextPage()"
          [disabled]="currentPage() === totalPages()"
          [class.opacity-50]="currentPage() === totalPages()"
          [class.cursor-not-allowed]="currentPage() === totalPages()"
          class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          Próxima
        </button>
      </div>
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div class="flex items-center gap-4">
          <p class="text-sm text-gray-700">
            Mostrando
            <span class="font-medium">{{
              (currentPage() - 1) * pageSize() + 1
            }}</span>
            até
            <span class="font-medium">{{
              Math.min(currentPage() * pageSize(), totalPatients())
            }}</span>
            de
            <span class="font-medium">{{ totalPatients() }}</span>
            resultados
          </p>
          <div class="flex items-center gap-2">
            <label for="pageSize" class="text-sm text-gray-700"
              >Itens por página:</label
            >
            <select
              id="pageSize"
              [value]="pageSize()"
              (change)="onPageSizeChange($event)"
              class="rounded-md border-gray-300 py-1 pl-2 pr-8 text-sm focus:border-violet-500 focus:outline-none focus:ring-violet-500"
            >
              @for (size of pageSizeOptions; track size) {
              <option [value]="size">{{ size }}</option>
              }
            </select>
          </div>
        </div>
        <div>
          <nav
            class="isolate inline-flex -space-x-px rounded-md shadow-sm"
            aria-label="Paginação"
          >
            <button
              (click)="previousPage()"
              [disabled]="currentPage() === 1"
              [class.opacity-50]="currentPage() === 1"
              [class.cursor-not-allowed]="currentPage() === 1"
              class="relative inline-flex items-center rounded-l-md border border-gray-300 bg-white px-2 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-20"
            >
              <span class="sr-only">Anterior</span>
              <svg
                class="h-5 w-5"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>

            @for (page of [].constructor(totalPages()); track $index) {
            <button
              (click)="goToPage($index + 1)"
              [class.bg-violet-50]="currentPage() === $index + 1"
              [class.border-violet-500]="currentPage() === $index + 1"
              [class.text-violet-600]="currentPage() === $index + 1"
              [class.z-10]="currentPage() === $index + 1"
              class="relative inline-flex items-center border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-20"
            >
              {{ $index + 1 }}
            </button>
            }

            <button
              (click)="nextPage()"
              [disabled]="currentPage() === totalPages()"
              [class.opacity-50]="currentPage() === totalPages()"
              [class.cursor-not-allowed]="currentPage() === totalPages()"
              class="relative inline-flex items-center rounded-r-md border border-gray-300 bg-white px-2 py-2 text-sm font-medium text-gray-500 hover:bg-gray-50 focus:z-20"
            >
              <span class="sr-only">Próxima</span>
              <svg
                class="h-5 w-5"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                aria-hidden="true"
              >
                <path
                  fill-rule="evenodd"
                  d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </div>
    }
  </div>
</div>
