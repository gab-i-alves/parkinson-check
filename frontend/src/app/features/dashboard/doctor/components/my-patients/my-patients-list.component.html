<div class="min-h-screen bg-neutral-50">
  <div class="max-w-7xl mx-auto px-6 py-8 space-y-6">
    <!-- Filtros -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
      <div class="space-y-4">
        <!-- Linha 1: Busca -->
        <div class="flex gap-4">
          <div class="flex-1 relative">
            <label for="search" class="block text-sm font-medium text-neutral-800 mb-2">
              Buscar Paciente
            </label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-5 h-5 text-neutral-400" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <input
                type="search"
                id="search"
                [value]="searchQuery()"
                (input)="onSearchChange($event)"
                (keyup.enter)="onSearch()"
                placeholder="Digite o nome ou CPF do paciente..."
                class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-neutral-300 text-sm focus:outline-none focus:ring-2 focus:ring-pink-200 focus:border-transparent"
              />
            </div>
          </div>

          <div class="flex-shrink-0 flex items-end">
            <button
              type="button"
              (click)="onSearch()"
              class="px-6 py-2.5 bg-neutral-900 text-white rounded-full text-sm font-medium hover:bg-neutral-800 transition-colors shadow-sm"
            >
              Pesquisar
            </button>
          </div>
        </div>

        <!-- Linha 2: Filtros -->
        <div class="flex flex-wrap gap-3">
          <div class="flex-shrink-0">
            <label
              for="status"
              class="block text-sm font-medium text-neutral-800 mb-2"
              appTooltip="Filtre pacientes por condi√ß√£o de sa√∫de"
              [tooltipPosition]="'top'"
            >
              Status
              <svg class="inline w-4 h-4 text-neutral-400 ml-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
              </svg>
            </label>
            <select
              id="status"
              [value]="selectedStatus()"
              (change)="onStatusChange($event)"
              class="px-4 py-2.5 pr-10 bg-white border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-200 focus:border-transparent appearance-none cursor-pointer"
            >
              <option value="">Todos os status</option>
              <option value="stable">Est√°vel</option>
              <option value="attention">Aten√ß√£o</option>
              <option value="critical">Cr√≠tico</option>
            </select>
          </div>

          <div class="flex-shrink-0">
            <label
              for="testType"
              class="block text-sm font-medium text-neutral-800 mb-2"
              appTooltip="Filtre pelo tipo do √∫ltimo teste realizado"
              [tooltipPosition]="'top'"
            >
              Tipo de Teste
              <svg class="inline w-4 h-4 text-neutral-400 ml-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
              </svg>
            </label>
            <select
              id="testType"
              [value]="selectedTestType()"
              (change)="onTestTypeChange($event)"
              class="px-4 py-2.5 pr-10 bg-white border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-200 focus:border-transparent appearance-none cursor-pointer"
            >
              <option value="">Todos os testes</option>
              <option value="spiral">Espiral</option>
              <option value="voice">Voz</option>
            </select>
          </div>

          <div class="flex-shrink-0">
            <label
              for="sortBy"
              class="block text-sm font-medium text-neutral-800 mb-2"
              appTooltip="Escolha como ordenar a lista"
              [tooltipPosition]="'top'"
            >
              Ordenar por
              <svg class="inline w-4 h-4 text-neutral-400 ml-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
              </svg>
            </label>
            <select
              id="sortBy"
              [value]="sortBy()"
              (change)="onSortChange($event)"
              class="px-4 py-2.5 pr-10 bg-white border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-200 focus:border-transparent appearance-none cursor-pointer"
            >
              <option value="name">Nome</option>
              <option value="age">Idade</option>
              <option value="lastTestDate">√öltimo Teste</option>
            </select>
          </div>

          <div class="flex-shrink-0">
            <label class="block text-sm font-medium text-neutral-800 mb-2">
              Ordem
            </label>
            <button
              type="button"
              (click)="toggleSortOrder()"
              class="px-4 py-2.5 bg-white border border-neutral-300 rounded-lg text-sm font-medium text-neutral-700 hover:bg-neutral-50 transition-colors"
              [title]="sortOrder() === 'asc' ? 'Crescente' : 'Decrescente'"
              appTooltip="{{ sortOrder() === 'asc' ? 'Alternar para decrescente' : 'Alternar para crescente' }}"
              [tooltipPosition]="'top'"
            >
              @if (sortOrder() === 'asc') {
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0l-3.75-3.75M17.25 21L21 17.25" />
              </svg>
              } @else {
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12" />
              </svg>
              }
            </button>
          </div>

          @if (searchQuery() || selectedStatus() || selectedTestType()) {
          <div class="flex-shrink-0 flex items-end">
            <button
              type="button"
              (click)="clearFilters()"
              class="px-4 py-2.5 bg-neutral-100 text-neutral-900 rounded-lg text-sm font-medium hover:bg-neutral-200 transition-colors"
            >
              Limpar filtros
            </button>
          </div>
          }
        </div>

        <!-- Filtros ativos (badges) -->
        @if (searchQuery() || selectedStatus() || selectedTestType()) {
        <div class="flex items-center gap-2 flex-wrap pt-2 border-t border-neutral-200">
          <span class="text-xs text-neutral-600 font-medium">Filtros ativos:</span>

          @if (searchQuery()) {
          <app-badge variant="pink">
            üîç "{{ searchQuery() }}"
          </app-badge>
          }

          @if (selectedStatus()) {
          <app-badge variant="blue">
            Status: {{ getStatusLabel(selectedStatus() || undefined) }}
          </app-badge>
          }

          @if (selectedTestType()) {
          <app-badge variant="yellow">
            Teste: {{ getTestTypeLabel(selectedTestType() || undefined) }}
          </app-badge>
          }
        </div>
        }
      </div>
    </div>

    <!-- Conte√∫do -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
      @if (isLoading()) {
      <!-- Skeleton Loader -->
      <div class="space-y-4 animate-pulse">
        <div class="h-4 bg-neutral-200 rounded-full w-3/4"></div>
        <div class="h-4 bg-neutral-200 rounded-full w-1/2"></div>

        <div class="space-y-3 pt-4">
          @for (item of [1,2,3,4,5]; track item) {
          <div class="flex items-center gap-4 p-4 bg-neutral-50 rounded-xl">
            <div class="w-12 h-12 bg-neutral-200 rounded-full"></div>
            <div class="flex-1 space-y-2">
              <div class="h-4 bg-neutral-200 rounded w-1/3"></div>
              <div class="h-3 bg-neutral-200 rounded w-1/4"></div>
            </div>
            <div class="h-8 bg-neutral-200 rounded-full w-20"></div>
          </div>
          }
        </div>
      </div>
      } @else if (patients().length === 0) {
      <!-- Empty State -->
      <div class="flex flex-col items-center justify-center py-16 px-4 text-center">
        <div class="w-20 h-20 bg-neutral-100 rounded-full flex items-center justify-center mb-4">
          <svg class="w-10 h-10 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
            />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-neutral-900 mb-2">
          Nenhum paciente encontrado
        </h3>
        <p class="text-sm text-neutral-600 mb-6 max-w-sm">
          @if (searchQuery() || selectedStatus() || selectedTestType()) {
            Tente ajustar os filtros ou realizar uma nova busca com termos diferentes.
          } @else {
            Voc√™ ainda n√£o possui pacientes vinculados. Quando houver pacientes, eles aparecer√£o aqui.
          }
        </p>
        @if (searchQuery() || selectedStatus() || selectedTestType()) {
        <button
          (click)="clearFilters()"
          class="px-6 py-2.5 bg-neutral-900 text-white rounded-full text-sm font-medium hover:bg-neutral-800 transition-colors"
        >
          Limpar filtros
        </button>
        }
      </div>
      } @else {
      <!-- Tabela de Pacientes -->
      <div class="overflow-x-auto -mx-6">
        <table class="w-full">
          <thead>
            <tr class="border-b border-neutral-200">
              <th class="text-left py-3 px-6 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                Paciente
              </th>
              <th class="text-left py-3 px-6 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                Idade
              </th>
              <th class="text-left py-3 px-6 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                √öltimo Teste
              </th>
              <th class="text-left py-3 px-6 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                Status
              </th>
              <th class="text-right py-3 px-6 text-xs font-medium text-neutral-500 uppercase tracking-wider">
                A√ß√µes
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-neutral-100">
            @for (patient of patients(); track patient.id) {
            <tr class="hover:bg-neutral-50 transition-colors">
              <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-pink-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-sm font-semibold text-neutral-900">
                      {{ patient.name.charAt(0).toUpperCase() }}
                    </span>
                  </div>
                  <div>
                    <div class="text-sm font-semibold text-neutral-900">
                      {{ patient.name }}
                    </div>
                    <div class="text-xs text-neutral-500">
                      {{ patient.cpf | cpf }}
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-neutral-900">{{ patient.age }} anos</div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-neutral-900">
                  {{ formatDate(patient.lastTestDate) }}
                </div>
                <div class="text-xs text-neutral-500">
                  {{ getTestTypeLabel(patient.lastTestType) }}
                </div>
              </td>
              <td class="px-6 py-4">
                <app-badge [variant]="getStatusVariant(patient.status)">
                  {{ getStatusLabel(patient.status) }}
                </app-badge>
              </td>
              <td class="px-6 py-4">
                <div class="flex items-center justify-end gap-2">
                  <a
                    [routerLink]="['/dashboard/doctor/patient', patient.id]"
                    class="px-4 py-2 bg-neutral-900 text-white rounded-lg text-xs font-medium hover:bg-neutral-800 transition-colors"
                  >
                    Ver Detalhes
                  </a>
                  <button
                    (click)="unlinkPatient(patient)"
                    class="px-4 py-2 bg-red-50 border border-red-200 text-red-700 rounded-lg text-xs font-medium hover:bg-red-100 transition-colors"
                    appTooltip="Remover v√≠nculo com este paciente"
                    [tooltipPosition]="'top'"
                  >
                    Desvincular
                  </button>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagina√ß√£o -->
      <div class="flex items-center justify-between border-t border-neutral-200 mt-6 pt-4">
        <div class="flex items-center gap-4">
          <p class="text-sm text-neutral-700">
            Mostrando
            <span class="font-semibold">{{ (currentPage() - 1) * pageSize() + 1 }}</span>
            at√©
            <span class="font-semibold">{{ Math.min(currentPage() * pageSize(), totalPatients()) }}</span>
            de
            <span class="font-semibold">{{ totalPatients() }}</span>
            pacientes
          </p>
          <div class="flex items-center gap-2">
            <label for="pageSize" class="text-sm text-neutral-700">Por p√°gina:</label>
            <select
              id="pageSize"
              [value]="pageSize()"
              (change)="onPageSizeChange($event)"
              class="px-3 py-1.5 border border-neutral-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-200 focus:border-transparent"
            >
              @for (size of pageSizeOptions; track size) {
              <option [value]="size">{{ size }}</option>
              }
            </select>
          </div>
        </div>

        <nav class="flex items-center gap-1">
          <button
            (click)="previousPage()"
            [disabled]="currentPage() === 1"
            class="px-3 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-neutral-100"
            [class.text-neutral-400]="currentPage() === 1"
            [class.text-neutral-700]="currentPage() !== 1"
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          @for (page of [].constructor(Math.min(totalPages(), 5)); track $index) {
          <button
            (click)="goToPage($index + 1)"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
            [class.bg-neutral-900]="currentPage() === $index + 1"
            [class.text-white]="currentPage() === $index + 1"
            [class.text-neutral-700]="currentPage() !== $index + 1"
            [class.hover:bg-neutral-100]="currentPage() !== $index + 1"
          >
            {{ $index + 1 }}
          </button>
          }

          @if (totalPages() > 5) {
          <span class="px-2 text-neutral-500">...</span>
          <button
            (click)="goToPage(totalPages())"
            class="px-4 py-2 rounded-lg text-sm font-medium transition-colors"
            [class.bg-neutral-900]="currentPage() === totalPages()"
            [class.text-white]="currentPage() === totalPages()"
            [class.text-neutral-700]="currentPage() !== totalPages()"
            [class.hover:bg-neutral-100]="currentPage() !== totalPages()"
          >
            {{ totalPages() }}
          </button>
          }

          <button
            (click)="nextPage()"
            [disabled]="currentPage() === totalPages()"
            class="px-3 py-2 rounded-lg text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-neutral-100"
            [class.text-neutral-400]="currentPage() === totalPages()"
            [class.text-neutral-700]="currentPage() !== totalPages()"
          >
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </nav>
      </div>
      }
    </div>
  </div>
</div>

<!-- Modal de confirma√ß√£o -->
@if (showUnlinkModal()) {
<app-confirmation-modal
  [title]="'Desvincular Paciente'"
  [message]="'Tem certeza que deseja desvincular o paciente ' + patientToUnlink()?.name + '? Esta a√ß√£o n√£o poder√° ser desfeita e voc√™ perder√° o acesso aos dados deste paciente.'"
  [type]="'danger'"
  [confirmButtonText]="'Sim, desvincular'"
  [cancelButtonText]="'Cancelar'"
  (confirm)="confirmUnlink()"
  (cancel)="cancelUnlink()"
/>
}
