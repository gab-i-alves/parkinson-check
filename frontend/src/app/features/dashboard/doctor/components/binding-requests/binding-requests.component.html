<div class="min-h-screen bg-neutral-50">
  <div class="container mx-auto px-6 py-8 space-y-6">
    <!-- Seção: Buscar Pacientes -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-8">
      <h2 class="text-xl font-bold text-neutral-900 mb-6">Buscar Pacientes</h2>

      <div class="mb-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
          <!-- Campo de busca -->
          <div class="lg:col-span-5">
            <label
              for="search-term"
              class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2"
            >
              Nome ou CPF do Paciente
            </label>
            <div class="relative">
              <div
                class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"
              >
                <svg
                  class="h-5 w-5 text-neutral-400"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <input
                type="text"
                id="search-term"
                [value]="searchTerm()"
                (input)="onSearchTermChange($event)"
                placeholder="Digite o nome ou CPF..."
                class="block w-full rounded-lg border-neutral-300 py-2.5 pl-10 pr-3 text-sm shadow-sm focus:border-pink-200 focus:ring-2 focus:ring-pink-200 transition-colors"
              />
            </div>
          </div>

          <!-- Filtro de Status -->
          <div class="lg:col-span-2">
            <label
              for="status-filter"
              class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2"
            >
              Status
            </label>
            <select
              id="status-filter"
              [value]="statusFilter()"
              (change)="statusFilter.set($any($event.target).value)"
              class="block w-full rounded-lg border-neutral-300 py-2.5 pl-3 pr-10 text-sm shadow-sm focus:border-pink-200 focus:ring-2 focus:ring-pink-200 transition-colors"
            >
              <option value="">Todos</option>
              <option value="stable">Estável</option>
              <option value="attention">Atenção</option>
              <option value="critical">Crítico</option>
            </select>
          </div>

          <!-- Ordenar por -->
          <div class="lg:col-span-2">
            <label
              for="sortBySearch"
              class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2"
            >
              Ordenar por
            </label>
            <select
              id="sortBySearch"
              [value]="sortBy()"
              (change)="onSortChange($event)"
              class="block w-full rounded-lg border-neutral-300 py-2.5 pl-3 pr-10 text-sm shadow-sm focus:border-pink-200 focus:ring-2 focus:ring-pink-200 transition-colors"
            >
              <option value="name">Nome</option>
              <option value="age">Idade</option>
              <option value="lastTestDate">Último Teste</option>
            </select>
          </div>

          <!-- Ordem -->
          <div class="lg:col-span-1">
            <label class="block text-xs font-medium text-neutral-500 uppercase tracking-wider mb-2">
              Ordem
            </label>
            <button
              type="button"
              (click)="toggleSortOrder()"
              class="w-full inline-flex items-center justify-center rounded-lg border border-neutral-300 bg-white px-4 py-2.5 text-sm font-medium text-neutral-700 shadow-sm hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-pink-200 focus:ring-offset-2 transition-colors"
              title="{{ sortOrder() === 'asc' ? 'Crescente' : 'Decrescente' }}"
            >
              @if (sortOrder() === 'asc') {
              <svg
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 4.5h14.25M3 9h9.75M3 13.5h9.75m4.5-4.5v12m0 0l-3.75-3.75M17.25 21L21 17.25"
                />
              </svg>
              } @else {
              <svg
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M3 4.5h14.25M3 9h9.75M3 13.5h5.25m5.25-.75L17.25 9m0 0L21 12.75M17.25 9v12"
                />
              </svg>
              }
            </button>
          </div>

          <!-- Botão de Pesquisar -->
          <div class="lg:col-span-2">
            <label class="block text-xs font-medium text-transparent uppercase tracking-wider mb-2">
              &nbsp;
            </label>
            <button
              type="button"
              (click)="searchPatients()"
              class="w-full inline-flex items-center justify-center rounded-full bg-neutral-900 px-6 py-2.5 text-sm font-semibold text-white shadow-md hover:bg-neutral-800 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-pink-200 focus:ring-offset-2 transition-all"
            >
              Pesquisar
            </button>
          </div>
        </div>
      </div>

      <!-- Loading state (Skeleton) -->
      @if (isLoadingSearch()) {
      <div class="space-y-3 animate-pulse">
        @for (item of [1,2,3,4,5]; track item) {
        <div class="flex items-center gap-4 p-4 bg-neutral-50 rounded-lg">
          <div class="w-10 h-10 bg-neutral-200 rounded-full"></div>
          <div class="flex-1 space-y-2">
            <div class="h-4 bg-neutral-200 rounded w-1/3"></div>
            <div class="h-3 bg-neutral-200 rounded w-1/4"></div>
          </div>
          <div class="h-6 bg-neutral-200 rounded-full w-20"></div>
          <div class="h-9 bg-neutral-200 rounded-lg w-32"></div>
        </div>
        }
      </div>
      } @else if (searchResults().length === 0 && searchTerm()) {
      <!-- Empty State -->
      <div class="py-12 text-center">
        <div
          class="flex h-16 w-16 items-center justify-center rounded-full bg-neutral-100 mx-auto mb-4"
        >
          <svg
            class="h-10 w-10 text-neutral-400"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
            />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-neutral-900">
          Nenhum paciente encontrado
        </h3>
        <p class="text-sm text-neutral-600 mt-2">
          Tente ajustar os filtros ou realizar uma nova busca.
        </p>
      </div>
      } @else if (searchResults().length > 0 && !isLoadingSearch()) {
      <!-- Resultados -->
      <div class="space-y-3">
        @for (patient of searchResults(); track patient.id) {
        <div class="flex items-center gap-4 p-4 border border-neutral-200 rounded-lg hover:bg-neutral-50 transition-colors">
          <!-- Avatar -->
          <div
            class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-pink-100 text-pink-700"
          >
            <span class="font-semibold text-sm">{{
              patient.name.charAt(0).toUpperCase()
            }}</span>
          </div>

          <!-- Info -->
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <h3 class="text-sm font-semibold text-neutral-900 truncate">
                {{ patient.name }}
              </h3>
              <app-badge [variant]="getStatusVariant(patient.status)">
                {{ getStatusLabel(patient.status) }}
              </app-badge>
            </div>
            <div class="flex items-center gap-3 text-xs text-neutral-600">
              <span>{{ patient.cpf | cpf }}</span>
              <span>•</span>
              <span>{{ patient.age }} anos</span>
            </div>
          </div>

          <!-- Action Button -->
          <button
            (click)="openInviteModal(patient)"
            [disabled]="
              patient.bindingStatus === 'pending' ||
              patient.bindingStatus === 'linked'
            "
            [class]="
              patient.bindingStatus === 'none'
                ? 'inline-flex items-center px-4 py-2 border border-pink-200 text-sm font-semibold rounded-lg text-pink-700 bg-pink-50 hover:bg-pink-100 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-200 transition-all'
                : 'inline-flex items-center px-4 py-2 border border-neutral-200 text-sm font-semibold rounded-lg text-neutral-400 bg-neutral-50 cursor-not-allowed'
            "
          >
            @if (patient.bindingStatus === 'none') {
            <span>Enviar Convite</span>
            } @else if (patient.bindingStatus === 'pending') {
            <span>Pendente</span>
            } @else {
            <span>Vinculado</span>
            }
          </button>
        </div>
        }
      </div>
      }
    </div>

    <!-- Seção: Solicitações -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-8">
      <h2 class="text-xl font-bold text-neutral-900 mb-6">Solicitações</h2>

      <!-- Pills Tabs -->
      <div class="mb-6 inline-flex items-center gap-2 bg-neutral-100 rounded-full p-1">
        <button
          (click)="setActiveTab('received')"
          [class.bg-white]="activeTab() === 'received'"
          [class.shadow-sm]="activeTab() === 'received'"
          [class.text-neutral-900]="activeTab() === 'received'"
          [class.text-neutral-600]="activeTab() !== 'received'"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all"
        >
          Recebidas
        </button>
        <button
          (click)="setActiveTab('sent')"
          [class.bg-white]="activeTab() === 'sent'"
          [class.shadow-sm]="activeTab() === 'sent'"
          [class.text-neutral-900]="activeTab() === 'sent'"
          [class.text-neutral-600]="activeTab() !== 'sent'"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all"
        >
          Enviadas
        </button>
      </div>

      <!-- Conteúdo aba Recebidas -->
      @if (activeTab() === 'received') {
        @if (isLoading()) {
        <!-- Skeleton Loader -->
        <div class="space-y-3 animate-pulse">
          @for (item of [1,2,3]; track item) {
          <div class="flex items-center gap-4 p-4 bg-neutral-50 rounded-lg">
            <div class="w-10 h-10 bg-neutral-200 rounded-full"></div>
            <div class="flex-1 space-y-2">
              <div class="h-4 bg-neutral-200 rounded w-1/3"></div>
              <div class="h-3 bg-neutral-200 rounded w-1/4"></div>
            </div>
            <div class="h-6 bg-neutral-200 rounded-full w-20"></div>
            <div class="flex gap-2">
              <div class="h-9 bg-neutral-200 rounded-lg w-24"></div>
              <div class="h-9 bg-neutral-200 rounded-lg w-24"></div>
              <div class="h-9 bg-neutral-200 rounded-lg w-24"></div>
            </div>
          </div>
          }
        </div>
        } @else if (requests().length === 0) {
        <!-- Empty State -->
        <div class="py-12 text-center">
          <div
            class="flex h-16 w-16 items-center justify-center rounded-full bg-neutral-100 mx-auto mb-4"
          >
            <svg
              class="h-10 w-10 text-neutral-400"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"
              />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-neutral-900">
            Nenhuma solicitação pendente
          </h3>
          <p class="text-sm text-neutral-600 mt-2">
            Você não possui solicitações de vínculo no momento.
          </p>
        </div>
        } @else {
        <!-- Lista de Solicitações Recebidas -->
        <div class="space-y-3">
          @for (req of requests(); track req.id) {
          <div class="flex items-center gap-4 p-4 border border-neutral-200 rounded-lg hover:bg-neutral-50 transition-colors">
            <!-- Avatar -->
            <div
              class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-blue-100 text-blue-700"
            >
              <span class="font-semibold text-sm">{{
                req.user.name.charAt(0).toUpperCase()
              }}</span>
            </div>

            <!-- Info -->
            <div class="flex-1 min-w-0">
              <h3 class="text-sm font-semibold text-neutral-900 mb-1">
                {{ req.user.name }}
              </h3>
              <p class="text-xs text-neutral-600">
                {{ getEmail(req.user) }}
              </p>
              @if (req.message) {
              <p class="text-xs text-neutral-500 italic mt-1">
                "{{ req.message }}"
              </p>
              }
            </div>

            <!-- Status Badge -->
            <app-badge variant="warning">
              Pendente
            </app-badge>

            <!-- Action Buttons -->
            <div class="flex items-center gap-2">
              <button
                (click)="viewPatientProfile(req)"
                class="inline-flex items-center px-4 py-2 border border-blue-200 text-sm font-semibold rounded-lg text-blue-700 bg-blue-50 hover:bg-blue-100 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-200 transition-all"
              >
                Ver Perfil
              </button>
              <button
                (click)="acceptRequest(req.id)"
                class="inline-flex items-center px-4 py-2 border border-green-200 text-sm font-semibold rounded-lg text-green-700 bg-green-50 hover:bg-green-100 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-200 transition-all"
              >
                Aceitar
              </button>
              <button
                (click)="rejectRequest(req.id)"
                class="inline-flex items-center px-4 py-2 border border-red-200 text-sm font-semibold rounded-lg text-red-700 bg-red-50 hover:bg-red-100 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-200 transition-all"
              >
                Recusar
              </button>
            </div>
          </div>
          }
        </div>
        }
      }

      <!-- Conteúdo aba Enviadas -->
      @if (activeTab() === 'sent') {
        @if (sentRequests().length === 0) {
        <!-- Empty State -->
        <div class="py-12 text-center">
          <div
            class="flex h-16 w-16 items-center justify-center rounded-full bg-neutral-100 mx-auto mb-4"
          >
            <svg
              class="h-10 w-10 text-neutral-400"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"
              />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-neutral-900">
            Nenhuma solicitação enviada
          </h3>
          <p class="text-sm text-neutral-600 mt-2">
            Você não possui solicitações de vínculo em andamento.
          </p>
        </div>
        } @else {
        <!-- Lista de Solicitações Enviadas -->
        <div class="space-y-3">
          @for (request of sentRequests(); track request.id) {
          <div class="flex items-center gap-4 p-4 border border-neutral-200 rounded-lg">
            <!-- Avatar -->
            <div
              class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-yellow-100 text-yellow-700"
            >
              <span class="font-semibold text-sm">{{
                request.user.name.charAt(0).toUpperCase()
              }}</span>
            </div>

            <!-- Info -->
            <div class="flex-1 min-w-0">
              <h3 class="text-sm font-semibold text-neutral-900 mb-1">
                {{ request.user.name }}
              </h3>
              <p class="text-xs text-neutral-600">
                {{ getEmail(request.user) }}
              </p>
              @if (request.message) {
              <p class="text-xs text-neutral-500 italic mt-1">
                "{{ request.message }}"
              </p>
              }
            </div>

            <!-- Status Badge -->
            <app-badge variant="warning">
              Pendente
            </app-badge>

            <!-- Action Button -->
            <button
              (click)="viewPatientProfile(request)"
              class="inline-flex items-center px-4 py-2 border border-blue-200 text-sm font-semibold rounded-lg text-blue-700 bg-blue-50 hover:bg-blue-100 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-200 transition-all"
            >
              Ver Perfil
            </button>
          </div>
          }
        </div>
        }
      }
    </div>
  </div>
</div>

<!-- Modal de Perfil -->
<app-doctor-profile-modal
  [doctor]="selectedPatient()"
  [isVisible]="isPatientProfileModalVisible()"
  [showMessageField]="showModalMessageField()"
  (close)="closePatientProfile()"
  (requestLink)="sendInviteWithMessage($event)"
></app-doctor-profile-modal>
