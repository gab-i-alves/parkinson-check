<div class="min-h-screen bg-neutral-50">
  @if (isLoading()) {
  <!-- Skeleton Loader -->
  <div class="container mx-auto px-6 py-8 space-y-8 animate-pulse">
    <!-- Header Skeleton -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-8">
      <div class="flex items-center space-x-3">
        <div class="h-14 w-14 bg-neutral-200 rounded-lg"></div>
        <div class="flex-1">
          <div class="h-8 bg-neutral-200 rounded w-1/3 mb-2"></div>
          <div class="h-4 bg-neutral-200 rounded w-1/4"></div>
        </div>
      </div>
    </div>

    <!-- Profile Card Skeleton -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
      <div class="h-6 bg-neutral-200 rounded w-32 mb-4"></div>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
      </div>
    </div>

    <!-- Charts Skeleton -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
        <div class="h-6 bg-neutral-200 rounded w-1/3 mb-4"></div>
        <div class="h-64 bg-neutral-200 rounded"></div>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
        <div class="h-6 bg-neutral-200 rounded w-1/3 mb-4"></div>
        <div class="h-64 bg-neutral-200 rounded"></div>
      </div>
    </div>
  </div>
  } @else if (!comparativeStats()) {
  <!-- Empty State -->
  <div class="container mx-auto px-6 py-8">
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-12 text-center">
      <div class="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-neutral-900 mb-2">Voc√™ ainda n√£o possui testes cl√≠nicos realizados</h3>
      <p class="text-sm text-neutral-600">Consulte seu m√©dico para realizar testes cl√≠nicos</p>
    </div>
  </div>
  } @else {
  <div class="container mx-auto px-6 py-8 space-y-8">
    <!-- Header -->
    <header class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-8">
      <div class="flex items-center space-x-3">
        <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-pink-100">
          <svg class="h-8 w-8 text-pink-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-neutral-900">Dashboard Comparativo</h1>
          <p class="text-sm text-neutral-600 mt-1">Veja como voc√™ se compara com outros pacientes</p>
        </div>
      </div>
    </header>

    <!-- Card Perfil do Paciente -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
      <h2 class="text-lg font-bold text-neutral-900 mb-4">Seu Perfil</h2>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="text-center p-3 bg-pink-50 rounded-lg border border-pink-100">
          <p class="text-xs text-neutral-600">Idade</p>
          <p class="text-xl font-bold text-neutral-900">{{ comparativeStats()!.demographics.age }} anos</p>
        </div>
        <div class="text-center p-3 bg-blue-50 rounded-lg border border-blue-100">
          <p class="text-xs text-neutral-600">Faixa Et√°ria</p>
          <p class="text-xl font-bold text-neutral-900">{{ comparativeStats()!.demographics.age_group }}</p>
        </div>
        <div class="text-center p-3 bg-pink-50 rounded-lg border border-pink-100">
          <p class="text-xs text-neutral-600">G√™nero</p>
          <p class="text-xl font-bold text-neutral-900">{{ comparativeStats()!.demographics.gender === 'male' ? 'Masculino' : 'Feminino' }}</p>
        </div>
        <div class="text-center p-3 bg-green-50 rounded-lg border border-green-100">
          <p class="text-xs text-neutral-600">Cidade</p>
          <p class="text-sm font-bold text-neutral-900">{{ comparativeStats()!.demographics.city }}</p>
        </div>
        <div class="text-center p-3 bg-yellow-50 rounded-lg border border-yellow-100">
          <p class="text-xs text-neutral-600">Estado</p>
          <p class="text-sm font-bold text-neutral-900">{{ comparativeStats()!.demographics.state }}</p>
        </div>
      </div>
    </div>

    <!-- Grid 1: Voc√™ vs M√©dia Global + Card Percentil -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Gr√°fico de Barras Verticais: Voc√™ vs M√©dia Global -->
      <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
        <h3 class="text-lg font-semibold text-neutral-900 mb-4">Voc√™ vs M√©dia Global</h3>
        <div class="relative" style="height: 300px;">
          <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="barChartType"></canvas>
        </div>
        <p class="text-xs text-neutral-500 mt-3 text-center">Comparando com {{ comparativeStats()!.total_patients_sharing_data }} pacientes</p>
      </div>

      <!-- Card Percentil com Barra de Progresso -->
      <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
        <h3 class="text-lg font-semibold text-neutral-900 mb-4">Seu Percentil no Sistema</h3>
        @if (comparativeStats()!.patient_percentile !== null) {
        <div class="space-y-4">
          <!-- Medalh√£o e Label -->
          <div class="text-center">
            <div class="text-5xl mb-2">{{ getPercentileMedal(comparativeStats()!.patient_percentile) }}</div>
            <p class="text-3xl font-bold text-neutral-900 mb-1">{{ comparativeStats()!.patient_percentile!.toFixed(0) }}¬∫</p>
            <p class="text-lg font-semibold" [ngClass]="{'text-green-600': comparativeStats()!.patient_percentile! >= 75, 'text-blue-600': comparativeStats()!.patient_percentile! >= 50 && comparativeStats()!.patient_percentile! < 75, 'text-yellow-600': comparativeStats()!.patient_percentile! >= 25 && comparativeStats()!.patient_percentile! < 50, 'text-red-600': comparativeStats()!.patient_percentile! < 25}">
              {{ getPercentileLabel(comparativeStats()!.patient_percentile) }}
            </p>
          </div>

          <!-- Barra de Progresso -->
          <div class="space-y-2">
            <div class="flex justify-between text-xs text-neutral-600">
              <span>0%</span>
              <span>50%</span>
              <span>100%</span>
            </div>
            <div class="relative h-8 bg-neutral-200 rounded-full overflow-hidden">
              <!-- Segmented background for context -->
              <div class="absolute inset-0 flex">
                <div class="flex-1 bg-red-300"></div>
                <div class="flex-1 bg-yellow-300"></div>
                <div class="flex-1 bg-blue-300"></div>
                <div class="flex-1 bg-green-300"></div>
              </div>

              <!-- Barra de progresso (√°rea n√£o preenchida) -->
              <div
                class="absolute top-0 left-0 h-full bg-neutral-200 transition-all duration-500"
                [style.width.%]="100 - comparativeStats()!.patient_percentile!">
              </div>

              <!-- Indicador de posi√ß√£o -->
              <div
                class="absolute top-0 h-full w-1 bg-neutral-900 shadow-lg transition-all duration-500"
                [style.left.%]="comparativeStats()!.patient_percentile!"
                [attr.title]="'Percentil ' + comparativeStats()!.patient_percentile!.toFixed(0)">
                <div class="absolute -top-1 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-neutral-900 rounded-full"></div>
                <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-neutral-900 rounded-full"></div>
              </div>
            </div>
            <p class="text-sm text-neutral-600 text-center mt-2">Voc√™ est√° melhor que <span class="font-bold text-pink-700">{{ comparativeStats()!.patient_percentile!.toFixed(0) }}%</span> dos pacientes</p>
          </div>
        </div>
        } @else {
        <p class="text-center text-neutral-500 py-8">Dados insuficientes</p>
        }
      </div>
    </div>

    <!-- Gr√°fico de Linha: Voc√™ vs Faixa Et√°ria vs Regi√£o -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-neutral-900">Compara√ß√£o por Faixa Et√°ria e Regi√£o</h3>
        <div class="flex items-center space-x-2">
          <label for="regionFilter" class="text-sm text-neutral-700">Regi√£o:</label>
          <select id="regionFilter" [ngModel]="regionFilter()" (ngModelChange)="onRegionFilterChange($event)" class="rounded-lg border-neutral-300 text-sm shadow-sm focus:border-pink-300 focus:ring-pink-200">
            <option value="city">Cidade</option>
            <option value="state">Estado</option>
            <option value="country">Pa√≠s</option>
          </select>
        </div>
      </div>
      <div class="relative" style="height: 300px;">
        <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [type]="lineChartType"></canvas>
      </div>
    </div>

    <!-- Grid 2: Compara√ß√£o por G√™nero + Compara√ß√£o Regional + Card Ranking -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Gr√°fico de Barras Horizontais: Por G√™nero -->
      <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
        <h3 class="text-lg font-semibold text-neutral-900 mb-4">Compara√ß√£o por G√™nero</h3>
        <div class="relative" style="height: 250px;">
          <canvas baseChart [data]="horizontalBarChartData" [options]="horizontalBarChartOptions" [type]="horizontalBarChartType"></canvas>
        </div>
      </div>

      <!-- Card Multi-Regional -->
      <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
        <h3 class="text-lg font-semibold text-neutral-900 mb-4">Compara√ß√£o Regional</h3>
        <div class="space-y-4">
          @if (comparativeStats()!.regional_avg.city !== null) {
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-neutral-700">Cidade ({{ comparativeStats()!.demographics.city }})</span>
              <span class="font-semibold">{{ comparativeStats()!.regional_avg.city!.toFixed(2) }}</span>
            </div>
            <div class="w-full bg-neutral-200 rounded-full h-2">
              <div class="bg-pink-600 h-2 rounded-full" [style.width.%]="(comparativeStats()!.regional_avg.city! * 100)"></div>
            </div>
          </div>
          }
          @if (comparativeStats()!.regional_avg.state !== null) {
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-neutral-700">Estado ({{ comparativeStats()!.demographics.state }})</span>
              <span class="font-semibold">{{ comparativeStats()!.regional_avg.state!.toFixed(2) }}</span>
            </div>
            <div class="w-full bg-neutral-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" [style.width.%]="(comparativeStats()!.regional_avg.state! * 100)"></div>
            </div>
          </div>
          }
          @if (comparativeStats()!.regional_avg.country !== null) {
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-neutral-700">Pa√≠s ({{ comparativeStats()!.demographics.country }})</span>
              <span class="font-semibold">{{ comparativeStats()!.regional_avg.country!.toFixed(2) }}</span>
            </div>
            <div class="w-full bg-neutral-200 rounded-full h-2">
              <div class="bg-green-600 h-2 rounded-full" [style.width.%]="(comparativeStats()!.regional_avg.country! * 100)"></div>
            </div>
          </div>
          }
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-neutral-700 font-bold">Voc√™</span>
              <span class="font-bold text-pink-700">{{ comparativeStats()!.patient_avg_score.toFixed(2) }}</span>
            </div>
            <div class="w-full bg-neutral-200 rounded-full h-2">
              <div class="bg-pink-700 h-2 rounded-full" [style.width.%]="(comparativeStats()!.patient_avg_score * 100)"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Medalh√£o/Ranking -->
      <div class="bg-pink-50 rounded-2xl shadow-sm border-2 border-pink-200 p-6">
        <h3 class="text-lg font-semibold text-neutral-900 mb-4 text-center">Sua Posi√ß√£o</h3>
        @if (comparativeStats()!.patient_percentile !== null) {
        <div class="text-center">
          <div class="text-6xl mb-3">{{ getPercentileMedal(comparativeStats()!.patient_percentile) || 'üèÖ' }}</div>
          <p class="text-2xl font-bold text-pink-700 mb-2">{{ getPercentileLabel(comparativeStats()!.patient_percentile) }}</p>
          <p class="text-sm text-neutral-700">Percentil {{ comparativeStats()!.patient_percentile!.toFixed(0) }}¬∫</p>
          <div class="mt-4 pt-4 border-t border-pink-200">
            <p class="text-xs text-neutral-600">Faixa Et√°ria: {{ comparativeStats()!.demographics.age_group }} anos</p>
            <p class="text-xs text-neutral-600 mt-1">Pacientes na sua faixa: {{ comparativeStats()!.total_patients_in_age_group }}</p>
          </div>
        </div>
        } @else {
        <p class="text-center text-neutral-500 py-8">Dados insuficientes</p>
        }
      </div>
    </div>

    <!-- Informa√ß√µes sobre Privacidade -->
    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6 shadow-sm">
      <div class="flex items-start space-x-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 border-2 border-blue-200 flex-shrink-0">
          <svg class="h-5 w-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-bold text-neutral-900 mb-2">Sobre as Estat√≠sticas Comparativas</h4>
          <p class="text-sm text-neutral-700">
            ‚Ä¢ Todas as compara√ß√µes s√£o feitas de forma an√¥nima e agregada<br>
            ‚Ä¢ Apenas pacientes que autorizaram o compartilhamento de dados s√£o inclu√≠dos nas estat√≠sticas<br>
            ‚Ä¢ Voc√™ pode alterar suas prefer√™ncias de compartilhamento nas Configura√ß√µes<br>
            ‚Ä¢ Os dados s√£o utilizados apenas para fins estat√≠sticos e nunca s√£o compartilhados individualmente
          </p>
        </div>
      </div>
    </div>
  </div>
  }
</div>
