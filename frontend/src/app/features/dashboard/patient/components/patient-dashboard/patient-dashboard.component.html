<div class="bg-neutral-50">
  @if (isLoading()) {
  <!-- Skeleton Loader -->
  <div class="container mx-auto px-6 py-8 space-y-8 animate-pulse">
    <!-- Header Skeleton -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-8">
      <div class="flex items-center space-x-3">
        <div class="h-14 w-14 bg-neutral-200 rounded-lg"></div>
        <div class="flex-1">
          <div class="h-8 bg-neutral-200 rounded w-1/3 mb-2"></div>
          <div class="h-4 bg-neutral-200 rounded w-1/4"></div>
        </div>
      </div>
    </div>

    <!-- Profile Card Skeleton -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
      <div class="h-6 bg-neutral-200 rounded w-32 mb-4"></div>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
        <div class="h-20 bg-neutral-200 rounded-lg"></div>
      </div>
    </div>

    <!-- Charts Skeleton -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
        <div class="h-6 bg-neutral-200 rounded w-1/3 mb-4"></div>
        <div class="h-64 bg-neutral-200 rounded"></div>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6">
        <div class="h-6 bg-neutral-200 rounded w-1/3 mb-4"></div>
        <div class="h-64 bg-neutral-200 rounded"></div>
      </div>
    </div>
  </div>
  } @else if (!comparativeStats()) {
  <!-- Empty State -->
  <div class="container mx-auto px-6 py-8">
    <div
      class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-12 text-center"
    >
      <div
        class="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <svg
          class="w-8 h-8 text-neutral-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-neutral-900 mb-2">
        Você ainda não possui testes clínicos realizados
      </h3>
      <p class="text-sm text-neutral-600">
        Consulte seu médico para realizar testes clínicos
      </p>
    </div>
  </div>
  } @else {
  <div class="container mx-auto px-6 py-8 space-y-8">
    <!-- SEÇÃO 1: VISÃO GERAL -->
    <div class="space-y-5">
      <h2 class="text-xl font-bold text-neutral-900">Sua Visão Geral</h2>

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <!-- KPI 1: Perfil Demográfico - AZUL -->
        <div
          class="bg-blue-100 rounded-2xl shadow-sm border border-blue-200 p-5 hover:shadow-md hover:-translate-y-1 transition-all duration-200 relative overflow-hidden"
        >
          <div
            class="absolute inset-0 opacity-20"
            style="
              background-image: radial-gradient(
                circle,
                rgb(26, 26, 26) 1px,
                transparent 1px
              );
              background-size: 16px 16px;
            "
          ></div>
          <div class="relative z-10">
            <div class="flex items-center gap-2 mb-2">
              <p class="text-xs font-medium text-neutral-700">Seu Perfil</p>
              <button
                type="button"
                class="inline-flex items-center justify-center p-1 rounded hover:bg-blue-200/50 transition-colors"
                aria-label="Informações sobre perfil demográfico"
                [appTooltip]="
                  'Informações demográficas usadas para comparar seu desempenho com pacientes similares em idade, gênero e localização'
                "
                [tooltipPosition]="'top'"
              >
                <svg
                  class="w-3.5 h-3.5 text-neutral-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
            <div class="flex flex-col items-center text-center space-y-1">
              <p class="text-2xl font-bold text-neutral-900">
                {{ comparativeStats()!.demographics.age }} anos
              </p>
              <p class="text-sm text-neutral-700">
                Faixa: {{ comparativeStats()!.demographics.age_group }}
              </p>
              <p class="text-sm text-neutral-700">
                {{
                  comparativeStats()!.demographics.gender === "male"
                    ? "Masculino"
                    : "Feminino"
                }}
              </p>
              <p class="text-xs text-neutral-600">
                {{ comparativeStats()!.demographics.city }}/{{
                  comparativeStats()!.demographics.state
                }}
              </p>
            </div>
          </div>
        </div>

        <!-- KPI 2: Seu Score Médio - ROSA -->
        <div
          class="bg-pink-100 rounded-2xl shadow-sm border border-pink-200 p-5 hover:shadow-md hover:-translate-y-1 transition-all duration-200 relative overflow-hidden"
        >
          <svg
            class="absolute bottom-0 right-0 w-24 h-24 opacity-20"
            viewBox="0 0 200 200"
          >
            <path
              d="M0,100 Q50,50 100,100 T200,100 L200,200 L0,200 Z"
              fill="currentColor"
            />
          </svg>
          <div class="relative z-10">
            <div class="flex items-center justify-center gap-2 mb-2">
              <p class="text-xs font-medium text-neutral-700">
                Seu Score Médio
              </p>
              <button
                type="button"
                class="inline-flex items-center justify-center p-1 rounded hover:bg-pink-200/50 transition-colors"
                aria-label="Informações sobre score médio"
                [appTooltip]="
                  'Média aritmética de todos os seus scores de testes concluídos (escala 0-100). Quanto maior, melhor seu desempenho nos testes'
                "
                [tooltipPosition]="'top'"
              >
                <svg
                  class="w-3.5 h-3.5 text-neutral-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
            <div class="flex flex-col items-center text-center space-y-1">
              <p class="text-4xl font-bold text-neutral-900">
                {{ (comparativeStats()!.patient_avg_score * 100).toFixed(1) }}
              </p>
              <p class="text-sm text-neutral-600">de 100 pontos</p>
            </div>
          </div>
        </div>

        <!-- KPI 3: Seu Percentil - VERDE -->
        <div
          class="bg-green-100 rounded-2xl shadow-sm border border-green-200 p-5 hover:shadow-md hover:-translate-y-1 transition-all duration-200 relative overflow-hidden"
        >
          <div class="absolute top-2 right-2 w-16 h-16 opacity-20">
            <div class="w-8 h-8 bg-current rounded-full"></div>
            <div
              class="w-5 h-5 bg-current rounded-full absolute top-3 left-6"
            ></div>
          </div>
          <div class="relative z-10">
            @if (comparativeStats()!.patient_percentile !== null) {
            <div class="flex items-center justify-center gap-2 mb-2">
              <p class="text-xs font-medium text-neutral-700">Seu Percentil</p>
              <button
                type="button"
                class="inline-flex items-center justify-center p-1 rounded hover:bg-green-200/50 transition-colors"
                aria-label="Informações sobre percentil"
                [appTooltip]="
                  'Posição relativa comparada a outros pacientes. Se você está no percentil 75, significa que seu desempenho é melhor que 75% dos pacientes'
                "
                [tooltipPosition]="'top'"
              >
                <svg
                  class="w-3.5 h-3.5 text-neutral-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
            <div class="flex flex-col items-center text-center space-y-1">
              <p class="text-4xl font-bold text-neutral-900">
                {{ comparativeStats()!.patient_percentile!.toFixed(0) }}º
              </p>
              <p class="text-sm text-neutral-600">
                Melhor que
                {{ comparativeStats()!.patient_percentile!.toFixed(0) }}%
              </p>
            </div>
            } @else {
            <div class="flex flex-col items-center text-center">
              <p class="text-xs font-medium text-neutral-700 mb-2">
                Seu Percentil
              </p>
              <p class="text-sm text-neutral-500">Dados insuficientes</p>
            </div>
            }
          </div>
        </div>

        <!-- KPI 4: Classificação - AMARELO -->
        <div
          class="bg-yellow-100 rounded-2xl shadow-sm border border-yellow-200 p-5 hover:shadow-md hover:-translate-y-1 transition-all duration-200 relative overflow-hidden"
        >
          <!-- Padrão decorativo: estrelas -->
          <div class="absolute inset-0 opacity-10">
            <svg
              class="absolute top-3 right-3 w-16 h-16"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
              />
            </svg>
            <svg
              class="absolute bottom-3 left-3 w-10 h-10"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
              />
            </svg>
          </div>
          <div class="relative z-10">
            @if (comparativeStats()!.patient_percentile !== null) {
            <div class="flex items-center gap-2 mb-2">
              <p class="text-xs font-medium text-neutral-700">Classificação</p>
              <button
                type="button"
                class="inline-flex items-center justify-center p-1 rounded hover:bg-yellow-200/50 transition-colors"
                aria-label="Informações sobre classificação"
                [appTooltip]="
                  'Classificação baseada no percentil: Excelente (≥75%), Bom (50-74%), Regular (25-49%), Precisa Atenção (<25%)'
                "
                [tooltipPosition]="'top'"
              >
                <svg
                  class="w-3.5 h-3.5 text-neutral-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
            <div class="flex flex-col items-center text-center">
              <span class="text-5xl mb-2">{{
                getPercentileMedal(comparativeStats()!.patient_percentile)
              }}</span>
              <span
                class="text-xl font-bold leading-tight"
                [ngClass]="{
                  'text-green-700':
                    comparativeStats()!.patient_percentile! >= 75,
                  'text-blue-700':
                    comparativeStats()!.patient_percentile! >= 50 &&
                    comparativeStats()!.patient_percentile! < 75,
                  'text-yellow-700':
                    comparativeStats()!.patient_percentile! >= 25 &&
                    comparativeStats()!.patient_percentile! < 50,
                  'text-red-700': comparativeStats()!.patient_percentile! < 25
                }"
              >
                {{ getPercentileLabel(comparativeStats()!.patient_percentile) }}
              </span>
            </div>
            } @else {
            <p class="text-xs font-medium text-neutral-700">Classificação</p>
            <p class="mt-2 text-sm text-neutral-500">Dados insuficientes</p>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- SEÇÃO 2: COMPARAÇÕES DE DESEMPENHO -->
    <div class="space-y-5">
      <h2 class="text-xl font-bold text-neutral-900">
        Comparações de Desempenho
      </h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Gráfico 1: Você vs Média Global -->
        <div
          class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6"
        >
          <div class="flex items-center gap-2 mb-4">
            <h3 class="text-lg font-semibold text-neutral-900">
              Você vs Média Global
            </h3>
            <button
              type="button"
              class="inline-flex items-center justify-center p-1 rounded hover:bg-neutral-100 transition-colors"
              aria-label="Informações sobre comparação com média global"
              [appTooltip]="
                'Compara seu score médio com a média global de todos os pacientes que compartilham dados anonimamente no sistema'
              "
              [tooltipPosition]="'top'"
            >
              <svg
                class="w-4 h-4 text-neutral-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
          <div class="relative" style="height: 300px">
            <canvas
              baseChart
              [data]="barChartData"
              [options]="barChartOptions"
              [type]="barChartType"
            ></canvas>
          </div>
          <p class="text-xs text-neutral-500 mt-3 text-center">
            Comparando com
            {{ comparativeStats()!.total_patients_sharing_data }} pacientes
          </p>
        </div>

        <!-- Gráfico 2: Você vs Faixa Etária e Região -->
        <div
          class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6"
        >
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <h3 class="text-lg font-semibold text-neutral-900">
                Você vs Faixa Etária e Região
              </h3>
              <button
                type="button"
                class="inline-flex items-center justify-center p-1 rounded hover:bg-neutral-100 transition-colors"
                aria-label="Informações sobre comparação por faixa etária e região"
                [appTooltip]="
                  'Compara seu desempenho com a média de pacientes na sua faixa etária e região selecionada (cidade, estado ou país)'
                "
                [tooltipPosition]="'top'"
              >
                <svg
                  class="w-4 h-4 text-neutral-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
            <div class="flex items-center space-x-2">
              <label for="regionFilter" class="text-sm text-neutral-700"
                >Região:</label
              >
              <button
                type="button"
                class="inline-flex items-center justify-center p-1 rounded hover:bg-neutral-100 transition-colors"
                aria-label="Informações sobre filtro regional"
                [appTooltip]="
                  'Selecione o nível de agregação regional para comparação: dados mais específicos (cidade) ou mais amplos (país)'
                "
                [tooltipPosition]="'top'"
              >
                <svg
                  class="w-3.5 h-3.5 text-neutral-600"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
              <select
                id="regionFilter"
                [ngModel]="regionFilter()"
                (ngModelChange)="onRegionFilterChange($event)"
                class="rounded-lg border-neutral-300 text-sm shadow-sm focus:border-pink-300 focus:ring-pink-200"
              >
                <option value="city">Cidade</option>
                <option value="state">Estado</option>
                <option value="country">País</option>
              </select>
            </div>
          </div>
          <div class="relative" style="height: 300px">
            <canvas
              baseChart
              [data]="lineChartData"
              [options]="lineChartOptions"
              [type]="lineChartType"
            ></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- SEÇÃO 3: ANÁLISES DETALHADAS -->
    <div class="space-y-5">
      <h2 class="text-xl font-bold text-neutral-900">Análises Detalhadas</h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Card 1: Comparação por Gênero -->
        <div
          class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6"
        >
          <div class="flex items-center gap-2 mb-4">
            <h3 class="text-lg font-semibold text-neutral-900">
              Comparação por Gênero
            </h3>
            <button
              type="button"
              class="inline-flex items-center justify-center p-1 rounded hover:bg-neutral-100 transition-colors"
              aria-label="Informações sobre comparação por gênero"
              [appTooltip]="
                'Compara seu score com as médias de pacientes masculinos e femininos dentro da sua faixa etária'
              "
              [tooltipPosition]="'top'"
            >
              <svg
                class="w-4 h-4 text-neutral-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
          <div class="relative" style="height: 280px">
            <canvas
              baseChart
              [data]="horizontalBarChartData"
              [options]="horizontalBarChartOptions"
              [type]="horizontalBarChartType"
            ></canvas>
          </div>
        </div>

        <!-- Card 2: Separação Regional -->
        <div
          class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6"
        >
          <div class="flex items-center gap-2 mb-4">
            <h3 class="text-lg font-semibold text-neutral-900">
              Separação Regional
            </h3>
            <button
              type="button"
              class="inline-flex items-center justify-center p-1 rounded hover:bg-neutral-100 transition-colors"
              aria-label="Informações sobre breakdown regional"
              [appTooltip]="
                'Mostra as médias regionais em diferentes níveis geográficos: sua cidade, estado e país, comparadas ao seu score'
              "
              [tooltipPosition]="'top'"
            >
              <svg
                class="w-4 h-4 text-neutral-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
          <div class="space-y-4 pt-4">
            @if (comparativeStats()!.regional_avg.city !== null) {
            <div>
              <div class="flex justify-between text-sm mb-1.5">
                <span class="text-neutral-700"
                  >Cidade ({{ comparativeStats()!.demographics.city }})</span
                >
                <span class="font-semibold text-pink-600">{{
                  (comparativeStats()!.regional_avg.city! * 100).toFixed(1)
                }}</span>
              </div>
              <div class="w-full bg-neutral-200 rounded-full h-2.5">
                <div
                  class="bg-pink-600 h-2.5 rounded-full transition-all duration-500"
                  [style.width.%]="comparativeStats()!.regional_avg.city! * 100"
                ></div>
              </div>
            </div>
            } @if (comparativeStats()!.regional_avg.state !== null) {
            <div>
              <div class="flex justify-between text-sm mb-1.5">
                <span class="text-neutral-700"
                  >Estado ({{ comparativeStats()!.demographics.state }})</span
                >
                <span class="font-semibold text-blue-600">{{
                  (comparativeStats()!.regional_avg.state! * 100).toFixed(1)
                }}</span>
              </div>
              <div class="w-full bg-neutral-200 rounded-full h-2.5">
                <div
                  class="bg-blue-600 h-2.5 rounded-full transition-all duration-500"
                  [style.width.%]="
                    comparativeStats()!.regional_avg.state! * 100
                  "
                ></div>
              </div>
            </div>
            } @if (comparativeStats()!.regional_avg.country !== null) {
            <div>
              <div class="flex justify-between text-sm mb-1.5">
                <span class="text-neutral-700"
                  >País ({{ comparativeStats()!.demographics.country }})</span
                >
                <span class="font-semibold text-green-600">{{
                  (comparativeStats()!.regional_avg.country! * 100).toFixed(1)
                }}</span>
              </div>
              <div class="w-full bg-neutral-200 rounded-full h-2.5">
                <div
                  class="bg-green-600 h-2.5 rounded-full transition-all duration-500"
                  [style.width.%]="
                    comparativeStats()!.regional_avg.country! * 100
                  "
                ></div>
              </div>
            </div>
            }
            <div class="pt-2 border-t border-neutral-200">
              <div class="flex justify-between text-sm mb-1.5">
                <span class="text-neutral-900 font-bold">Seu Score</span>
                <span class="font-bold text-pink-700">{{
                  (comparativeStats()!.patient_avg_score * 100).toFixed(1)
                }}</span>
              </div>
              <div class="w-full bg-neutral-200 rounded-full h-2.5">
                <div
                  class="bg-pink-700 h-2.5 rounded-full transition-all duration-500"
                  [style.width.%]="comparativeStats()!.patient_avg_score * 100"
                ></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Card 3: Visualização do Percentil -->
        <div
          class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-6"
        >
          <div class="flex items-center gap-2 mb-4">
            <h3 class="text-lg font-semibold text-neutral-900">
              Visualização do Percentil
            </h3>
            <button
              type="button"
              class="inline-flex items-center justify-center p-1 rounded hover:bg-neutral-100 transition-colors"
              aria-label="Informações sobre visualização do percentil"
              [appTooltip]="
                'Representação visual da sua posição percentual. A barra colorida indica em qual quartil você se encontra: vermelho (0-25%), amarelo (25-50%), azul (50-75%), verde (75-100%)'
              "
              [tooltipPosition]="'top'"
            >
              <svg
                class="w-4 h-4 text-neutral-600"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </div>
          @if (comparativeStats()!.patient_percentile !== null) {
          <div class="space-y-4 pt-4">
            <!-- Barra de Progresso Segmentada -->
            <div class="space-y-2">
              <div class="flex justify-between text-xs text-neutral-600">
                <span>0%</span>
                <span>25%</span>
                <span>50%</span>
                <span>75%</span>
                <span>100%</span>
              </div>
              <div
                class="relative h-10 bg-neutral-200 rounded-full overflow-hidden"
              >
                <!-- Segmented background -->
                <div class="absolute inset-0 flex">
                  <div class="flex-1 bg-red-300"></div>
                  <div class="flex-1 bg-yellow-300"></div>
                  <div class="flex-1 bg-blue-300"></div>
                  <div class="flex-1 bg-green-300"></div>
                </div>

                <!-- Overlay não preenchido -->
                <div
                  class="absolute top-0 left-0 h-full bg-neutral-200 transition-all duration-500"
                  [style.width.%]="
                    100 - comparativeStats()!.patient_percentile!
                  "
                ></div>

                <!-- Indicador de posição -->
                <div
                  class="absolute top-0 h-full w-1.5 bg-neutral-900 shadow-lg transition-all duration-500"
                  [style.left.%]="comparativeStats()!.patient_percentile!"
                >
                  <div
                    class="absolute -top-1 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-neutral-900 rounded-full"
                  ></div>
                  <div
                    class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-neutral-900 rounded-full"
                  ></div>
                </div>
              </div>
            </div>

            <!-- Estatísticas -->
            <div class="bg-neutral-50 rounded-xl p-4 space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-sm text-neutral-600"
                  >Você está melhor que:</span
                >
                <span class="text-2xl font-bold text-pink-700"
                  >{{
                    comparativeStats()!.patient_percentile!.toFixed(0)
                  }}%</span
                >
              </div>
              <div class="flex justify-between items-center text-xs">
                <span class="text-neutral-600">Pacientes na sua faixa:</span>
                <span class="font-semibold text-neutral-900">{{
                  comparativeStats()!.total_patients_in_age_group
                }}</span>
              </div>
              <div class="flex justify-between items-center text-xs">
                <span class="text-neutral-600"
                  >Total compartilhando dados:</span
                >
                <span class="font-semibold text-neutral-900">{{
                  comparativeStats()!.total_patients_sharing_data
                }}</span>
              </div>
            </div>
          </div>
          } @else {
          <p class="text-center text-neutral-500 py-12">
            Dados insuficientes para cálculo de percentil
          </p>
          }
        </div>
      </div>
    </div>

    <!-- Informações sobre Privacidade -->
    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6 shadow-sm">
      <div class="flex items-start space-x-3">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 border-2 border-blue-200 flex-shrink-0"
        >
          <svg
            class="h-5 w-5 text-blue-700"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-bold text-neutral-900 mb-2">
            Sobre as Estatísticas Comparativas
          </h4>
          <p class="text-sm text-neutral-700">
            • Todas as comparações são feitas de forma anônima e agregada<br />
            • Apenas pacientes que autorizaram o compartilhamento de dados são
            incluídos nas estatísticas<br />
            • Você pode alterar suas preferências de compartilhamento nas
            Configurações<br />
            • Os dados são utilizados apenas para fins estatísticos e nunca são
            compartilhados individualmente
          </p>
        </div>
      </div>
    </div>
  </div>
  }
</div>
