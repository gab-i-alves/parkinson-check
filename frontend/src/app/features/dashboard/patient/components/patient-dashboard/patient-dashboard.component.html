<div class="min-h-screen bg-gray-100 relative overflow-hidden">
  <!-- Background decorativo -->
  <div class="absolute top-0 left-0 w-full h-full -z-10 overflow-hidden">
    <div class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-violet-200/30 rounded-full filter blur-3xl opacity-50"></div>
    <div class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-purple-200/30 rounded-full filter blur-3xl opacity-40"></div>
    <div class="absolute top-[30%] left-[10%] w-64 h-64 bg-orange-200/30 rounded-full filter blur-3xl opacity-35"></div>
  </div>

  @if (isLoading()) {
  <div class="flex h-screen items-center justify-center">
    <div class="text-center">
      <svg class="inline-block animate-spin rounded-full h-12 w-12 text-violet-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-gray-600 mt-4 font-medium">Carregando dashboard comparativo...</p>
    </div>
  </div>
  } @else if (!comparativeStats()) {
  <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/50 p-12 text-center mx-6 my-8">
    <div class="flex h-16 w-16 items-center justify-center rounded-lg bg-gray-100 border-2 border-gray-200 mx-auto mb-4">
      <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-900">Voc√™ ainda n√£o possui testes cl√≠nicos realizados</h3>
    <p class="text-sm text-gray-600 mt-2">Consulte seu m√©dico para realizar testes cl√≠nicos</p>
  </div>
  } @else {
  <div class="container mx-auto px-6 py-8 space-y-8 relative">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/50 p-8">
      <div class="flex items-center space-x-3">
        <div class="flex h-14 w-14 items-center justify-center rounded-lg bg-violet-700 shadow-lg">
          <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Dashboard Comparativo</h1>
          <p class="text-sm text-gray-600 mt-1">Veja como voc√™ se compara com outros pacientes</p>
        </div>
      </div>
    </header>

    <!-- Card Perfil do Paciente -->
    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/50 p-6">
      <h2 class="text-lg font-bold text-gray-900 mb-4">Seu Perfil</h2>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div class="text-center p-3 bg-violet-50 rounded-lg">
          <p class="text-xs text-gray-600">Idade</p>
          <p class="text-xl font-bold text-gray-900">{{ comparativeStats()!.demographics.age }} anos</p>
        </div>
        <div class="text-center p-3 bg-blue-50 rounded-lg">
          <p class="text-xs text-gray-600">Faixa Et√°ria</p>
          <p class="text-xl font-bold text-gray-900">{{ comparativeStats()!.demographics.age_group }}</p>
        </div>
        <div class="text-center p-3 bg-pink-50 rounded-lg">
          <p class="text-xs text-gray-600">G√™nero</p>
          <p class="text-xl font-bold text-gray-900">{{ comparativeStats()!.demographics.gender === 'male' ? 'Masculino' : 'Feminino' }}</p>
        </div>
        <div class="text-center p-3 bg-green-50 rounded-lg">
          <p class="text-xs text-gray-600">Cidade</p>
          <p class="text-sm font-bold text-gray-900">{{ comparativeStats()!.demographics.city }}</p>
        </div>
        <div class="text-center p-3 bg-orange-50 rounded-lg">
          <p class="text-xs text-gray-600">Estado</p>
          <p class="text-sm font-bold text-gray-900">{{ comparativeStats()!.demographics.state }}</p>
        </div>
      </div>
    </div>

    <!-- Grid 1: Voc√™ vs M√©dia Global + Card Percentil -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Gr√°fico de Barras Verticais: Voc√™ vs M√©dia Global -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Voc√™ vs M√©dia Global</h3>
        <div class="relative" style="height: 300px;">
          <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="barChartType"></canvas>
        </div>
        <p class="text-xs text-gray-500 mt-3 text-center">Comparando com {{ comparativeStats()!.total_patients_sharing_data }} pacientes</p>
      </div>

      <!-- Card Percentil com Barra de Progresso -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Seu Percentil no Sistema</h3>
        @if (comparativeStats()!.patient_percentile !== null) {
        <div class="space-y-4">
          <!-- Medalh√£o e Label -->
          <div class="text-center">
            <div class="text-5xl mb-2">{{ getPercentileMedal(comparativeStats()!.patient_percentile) }}</div>
            <p class="text-3xl font-bold text-gray-900 mb-1">{{ comparativeStats()!.patient_percentile!.toFixed(0) }}¬∫</p>
            <p class="text-lg font-semibold" [ngClass]="{'text-green-600': comparativeStats()!.patient_percentile! >= 75, 'text-blue-600': comparativeStats()!.patient_percentile! >= 50 && comparativeStats()!.patient_percentile! < 75, 'text-orange-600': comparativeStats()!.patient_percentile! >= 25 && comparativeStats()!.patient_percentile! < 50, 'text-red-600': comparativeStats()!.patient_percentile! < 25}">
              {{ getPercentileLabel(comparativeStats()!.patient_percentile) }}
            </p>
          </div>

          <!-- Barra de Progresso -->
          <div class="space-y-2">
            <div class="flex justify-between text-xs text-gray-600">
              <span>0%</span>
              <span>50%</span>
              <span>100%</span>
            </div>
            <div class="relative h-8 bg-gray-200 rounded-full overflow-hidden">
              <!-- Gradient background para contexto -->
              <div class="absolute inset-0 bg-gradient-to-r from-red-300 via-orange-300 via-yellow-300 via-blue-300 to-green-400"></div>

              <!-- Barra de progresso -->
              <div
                class="absolute top-0 left-0 h-full bg-gray-200 transition-all duration-500"
                [style.width.%]="100 - comparativeStats()!.patient_percentile!">
              </div>

              <!-- Indicador de posi√ß√£o -->
              <div
                class="absolute top-0 h-full w-1 bg-gray-900 shadow-lg transition-all duration-500"
                [style.left.%]="comparativeStats()!.patient_percentile!"
                [attr.title]="'Percentil ' + comparativeStats()!.patient_percentile!.toFixed(0)">
                <div class="absolute -top-1 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-900 rounded-full"></div>
                <div class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-gray-900 rounded-full"></div>
              </div>
            </div>
            <p class="text-sm text-gray-600 text-center mt-2">Voc√™ est√° melhor que <span class="font-bold text-violet-700">{{ comparativeStats()!.patient_percentile!.toFixed(0) }}%</span> dos pacientes</p>
          </div>
        </div>
        } @else {
        <p class="text-center text-gray-500 py-8">Dados insuficientes</p>
        }
      </div>
    </div>

    <!-- Gr√°fico de Linha: Voc√™ vs Faixa Et√°ria vs Regi√£o -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Compara√ß√£o por Faixa Et√°ria e Regi√£o</h3>
        <div class="flex items-center space-x-2">
          <label for="regionFilter" class="text-sm text-gray-700">Regi√£o:</label>
          <select id="regionFilter" [ngModel]="regionFilter()" (ngModelChange)="onRegionFilterChange($event)" class="rounded-md border-gray-300 text-sm shadow-sm focus:border-violet-500 focus:ring-violet-500">
            <option value="city">Cidade</option>
            <option value="state">Estado</option>
            <option value="country">Pa√≠s</option>
          </select>
        </div>
      </div>
      <div class="relative" style="height: 300px;">
        <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [type]="lineChartType"></canvas>
      </div>
    </div>

    <!-- Grid 2: Compara√ß√£o por G√™nero + Compara√ß√£o Regional + Card Ranking -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Gr√°fico de Barras Horizontais: Por G√™nero -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Compara√ß√£o por G√™nero</h3>
        <div class="relative" style="height: 250px;">
          <canvas baseChart [data]="horizontalBarChartData" [options]="horizontalBarChartOptions" [type]="horizontalBarChartType"></canvas>
        </div>
      </div>

      <!-- Card Multi-Regional -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Compara√ß√£o Regional</h3>
        <div class="space-y-4">
          @if (comparativeStats()!.regional_avg.city !== null) {
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-700">Cidade ({{ comparativeStats()!.demographics.city }})</span>
              <span class="font-semibold">{{ comparativeStats()!.regional_avg.city!.toFixed(2) }}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-violet-600 h-2 rounded-full" [style.width.%]="(comparativeStats()!.regional_avg.city! * 100)"></div>
            </div>
          </div>
          }
          @if (comparativeStats()!.regional_avg.state !== null) {
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-700">Estado ({{ comparativeStats()!.demographics.state }})</span>
              <span class="font-semibold">{{ comparativeStats()!.regional_avg.state!.toFixed(2) }}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" [style.width.%]="(comparativeStats()!.regional_avg.state! * 100)"></div>
            </div>
          </div>
          }
          @if (comparativeStats()!.regional_avg.country !== null) {
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-700">Pa√≠s ({{ comparativeStats()!.demographics.country }})</span>
              <span class="font-semibold">{{ comparativeStats()!.regional_avg.country!.toFixed(2) }}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-green-600 h-2 rounded-full" [style.width.%]="(comparativeStats()!.regional_avg.country! * 100)"></div>
            </div>
          </div>
          }
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-700 font-bold">Voc√™</span>
              <span class="font-bold text-violet-700">{{ comparativeStats()!.patient_avg_score.toFixed(2) }}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-violet-700 h-2 rounded-full" [style.width.%]="(comparativeStats()!.patient_avg_score * 100)"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card Medalh√£o/Ranking -->
      <div class="bg-gradient-to-br from-violet-50 to-purple-50 rounded-lg shadow-md p-6 border-2 border-violet-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">Sua Posi√ß√£o</h3>
        @if (comparativeStats()!.patient_percentile !== null) {
        <div class="text-center">
          <div class="text-6xl mb-3">{{ getPercentileMedal(comparativeStats()!.patient_percentile) || 'üèÖ' }}</div>
          <p class="text-2xl font-bold text-violet-700 mb-2">{{ getPercentileLabel(comparativeStats()!.patient_percentile) }}</p>
          <p class="text-sm text-gray-700">Percentil {{ comparativeStats()!.patient_percentile!.toFixed(0) }}¬∫</p>
          <div class="mt-4 pt-4 border-t border-violet-200">
            <p class="text-xs text-gray-600">Faixa Et√°ria: {{ comparativeStats()!.demographics.age_group }} anos</p>
            <p class="text-xs text-gray-600 mt-1">Pacientes na sua faixa: {{ comparativeStats()!.total_patients_in_age_group }}</p>
          </div>
        </div>
        } @else {
        <p class="text-center text-gray-500 py-8">Dados insuficientes</p>
        }
      </div>
    </div>

    <!-- Informa√ß√µes sobre Privacidade -->
    <div class="bg-blue-50/50 border border-blue-200 rounded-2xl p-6 shadow-md">
      <div class="flex items-start space-x-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 border-2 border-blue-200 flex-shrink-0">
          <svg class="h-5 w-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-bold text-gray-900 mb-2">Sobre as Estat√≠sticas Comparativas</h4>
          <p class="text-sm text-gray-700">
            ‚Ä¢ Todas as compara√ß√µes s√£o feitas de forma an√¥nima e agregada<br>
            ‚Ä¢ Apenas pacientes que autorizaram o compartilhamento de dados s√£o inclu√≠dos nas estat√≠sticas<br>
            ‚Ä¢ Voc√™ pode alterar suas prefer√™ncias de compartilhamento nas Configura√ß√µes<br>
            ‚Ä¢ Os dados s√£o utilizados apenas para fins estat√≠sticos e nunca s√£o compartilhados individualmente
          </p>
        </div>
      </div>
    </div>
  </div>
  }
</div>
